## 1. H2 데이터베이스 설치

- https://www.h2database.com/html/main.html
- 다운로드 및 설치
- 실행: `./h2.bat`
    - git bash에서 실행한다.
    - bin 폴더 안에 있다.
        
        ![image](https://github.com/muyaaho/project-board/assets/76798969/bc1337db-b1a6-4e1d-9b54-8a9ff0dd0a12)

    - 최초 한 번 `jdbc:h2:경로` 실행한다.
        
        ![image](https://github.com/muyaaho/project-board/assets/76798969/3f888291-5766-4042-a305-bb63161830aa)

        - 홈 디렉토리에 저장하려면 다음과 같이 url을 설정한다: `jdbc:h2:~/test`
    - `경로/db.md.db` 파일 생성 확인
        
        ![image](https://github.com/muyaaho/project-board/assets/76798969/13e5dfab-b1fd-4269-8eef-d931d6f0e3bb)


        - 홈디렉토리에 저장했다면 `~/test.mv.db` 파일 생성을 확인한다.
    - 이후부터는 `jdbc:h2:tcp://localhost/경로\db` 이렇게 접속한다.
        - 본인: `jdbc:h2:tcp://localhost/C:\Workspace\project\board\data\db`
- 스프링 부트에 설정 추가
    
    ```java
    spring.datasource.url=jdbc:h2:tcp://localhost/C:/Workspace/project/board/data/db
    spring.datasource.driver-class-name=org.h2.Driver
    spring.datasource.username=sa
    ```
    

## 2. 실행되도록 데이터 테이블 추가

```java
2024-04-06T20:11:51.868+09:00 ERROR 20636 --- [board] [nio-8080-exec-1] o.h.engine.jdbc.spi.SqlExceptionHelper   : Table "POST" not found (this database is empty); SQL statement:
select p1_0.id,p1_0.content,p1_0.title,p1_0.username from post p1_0 [42104-224]
2024-04-06T20:11:51.879+09:00 ERROR 20636 --- [board] [nio-8080-exec-1] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed: org.springframework.dao.InvalidDataAccessResourceUsageException: could not prepare statement [Table "POST" not found (this database is empty); SQL statement:
select p1_0.id,p1_0.content,p1_0.title,p1_0.username from post p1_0 [42104-224]] [select p1_0.id,p1_0.content,p1_0.title,p1_0.username from post p1_0]; SQL [select p1_0.id,p1_0.content,p1_0.title,p1_0.username from post p1_0]] with root cause

org.h2.jdbc.JdbcSQLSyntaxErrorException: Table "POST" not found (this database is empty); SQL statement:
select p1_0.id,p1_0.content,p1_0.title,p1_0.username from post p1_0 [42104-224]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:514) ~[h2-2.2.224.jar:2.2.224]
	at org.h2.engine.SessionRemote.readException(SessionRemote.java:650) ~[h2-2.2.224.jar:2.2.224]

```

위 과정가까지 하고 실행하면 Table이 없다는 에러가 나온다. h2-console에 들어가서 테이블을 sql로 생성하자

쿼리를 직접 생성하려 했으나 까먹어서 `spring.jpa.hibernate.ddl-auto=create` 옵션으로 확인

```sql
    create table comment (
        id bigint generated by default as identity,
        post_id bigint,
        body varchar(255),
        nickname varchar(255),
        primary key (id)
    )

    create table post (
        id bigint generated by default as identity,
        content varchar(255),
        title varchar(255),
        username varchar(255),
        primary key (id)
    )

```

이전에 만들어둔 더미데이터를 db에 저장한다. 

<img src=https://github.com/muyaaho/project-board/assets/76798969/8c62e538-c425-43f0-8abe-fb0dfd474813 width="80%" height="80%"/><br>

참고로 이전에는 메모리에 저장되는 h2 db를 사용했었다.
`spring.jpa.defer-datasource-initialization=true` 옵션으로 인해 데이터 소스가 있으면 실행될 때마다 resources/data.sql이 실행되면서 매번 데이터가 업그레이드 되었다.

데이터가 잘 저장되었는지 확인해보자
<br><img src=https://github.com/muyaaho/project-board/assets/76798969/398d2e35-3f8f-42f0-8f46-31180b9e1267 width="60%" height="60%"/><br>
이제 새로 시작해도 데이터가 업그레이드 되지 않는다.

localhost:8080/board 를 확인하면 데이터가 잘 들어간 모습을 볼 수 있다.

## 3. 댓글 등록 후 화면 업데이트

```jsx
// fetch() - 비동기 통신을 위한 API
const url = "/api/board/" + comment.postId + "/comments";
fetch(url, {
    method: "POST",
    headers: {
        "Content-Type": "application/json"
    },
    body: JSON.stringify(comment)
});
window.location.reload();
```

fetch 다음 `window.location.reload()`를 추가한다

## 4. [외래키 지정](https://www.tcpschool.com/mysql/mysql_constraint_foreignKey)

관계형 데이터베이스에서 외래 키(Foreign Key)는 한 테이블의 필드 중 다른 테이블의 행을 식별할 수 있는 키를 말한다. 

지정하는 방법은 테이블을 생성할 때 외래키를 지정하거나 ALTER문으로 새로운 필드를 추가하거나 수정할 때 외래키를 지정할 수 있다. 

```sql
ALTER TABLE 자식테이블
ADD FOREIGN KEY (FK 컬럼) REFERENCES 부모테이블(PK 컬럼);
```

ALTER문으로 기존에 있는 필드를 외래키로 수정한다.

<br><img src=https://github.com/muyaaho/project-board/assets/76798969/aa267e31-0b84-4028-b1e8-2f3d29a53bb2 width="60%" height="60%"/><br>

<br><img src=https://github.com/muyaaho/project-board/assets/76798969/b0ab5c5a-0793-42f6-92d9-3f8391b76825 width="80%" height="80%"/><br>
